# TASKS.yaml — Phased plan with owner, deps, DoD
# status: todo | in_progress | blocked | review | done
# owner: manual | codex

meta:
  last_updated: "2025-10-08 21:34"
  actor: "codex"

phases:
  - id: P0
    name: Repo Hygiene & Protocol Setup
    tasks:
      - id: P0.1
        title: Create protocol files (this commit)
        owner: manual
        status: done
        dod: "Files exist under docs/protocol; committed on branch inventory_foundation_v1"
      - id: P0.2
        title: Audit legacy inventory code & files
        owner: codex
        status: done
        status_log:
          - status: in_progress
            at: "2025-10-07 13:09"
            actor: codex
          - status: review
            at: "2025-10-07 13:10"
            actor: codex
          - status: done
            at: "2025-10-07 13:11"
            actor: codex
        deps: [P0.1]
        notes: "Search for stock_on_hand.csv, ActiveOrders, dashboard.py, streamlit, etl_* in repo; list conflicts"
        dod: "ISSUES.md lists conflicts; DECISIONS.md lists what to archive/migrate"
      - id: P0.3
        title: Protected paths guardrails
        owner: codex
        status: done
        status_log:
          - status: in_progress
            at: "2025-10-07 14:40"
            actor: codex
          - status: done
            at: "2025-10-07 14:40"
            actor: codex
        deps: [P0.2]
        dod: "Pre-commit guard + installer enforce protected paths; OPERATING.md documents setup"

  - id: P1
    name: Data Foundation (DB + Config)
    tasks:
      - id: P1.1
        title: Define DB schema models & migrations
        owner: codex
        status: done
        status_log:
          - status: in_progress
            at: "2025-10-07 13:31"
            actor: codex
          - status: review
            at: "2025-10-07 13:38"
            actor: codex
          - status: done
            at: "2025-10-07 13:39"
            actor: codex
        deps: [P0.2]
        dod: "products, offer_to_sku_key, stock_snapshots, sales_daily, orders, size_mix, demand_forecasts, diagnostics, inventory_policy, po_plan created; migration committed"
      - id: P1.2
        title: Create CONFIG.example.yaml & .env.example
        owner: codex
        status: done
        status_log:
          - status: in_progress
            at: "2025-10-07 14:56"
            actor: codex
          - status: done
            at: "2025-10-07 14:56"
            actor: codex
        deps: [P1.1]
        dod: "docs/protocol/CONFIG.example.yaml filled; .env.example at repo root"
      - id: P1.2a
        title: Stabilize config & clean ETL API
        owner: codex
        status: done
        status_log:
          - status: in_progress
            at: "2025-10-07 17:23"
            actor: codex
          - status: done
            at: "2025-10-07 17:23"
            actor: codex
        deps: [P1.2]
        dod: "EtL API retries consolidated; config deps aligned with trimmed requirements"
      - id: P1.3
        title: Load baseline dims from XLSX (Sku_Map, size mix, delivery bands)
        owner: codex
        status: done
        status_log:
          - status: in_progress
            at: "2025-10-07 19:32"
            actor: codex
          - status: done
            at: "2025-10-07 19:32"
            actor: codex
        deps: [P1.1]
        dod: "Loader scripts populate products, size_mix, delivery_bands; logs in PROGRESS.md"
      - id: P1.4
        title: Offers ingest (Business_model → offers)
        owner: codex
        status: done
        status_log:
          - status: in_progress
            at: "2025-10-08 17:22"
            actor: codex
          - status: done
            at: "2025-10-08 17:22"
            actor: codex
        deps: [P1.3]
        dod: "Offers table hydrated from Business_model with account-specific IDs"
      - id: P1.3b
        title: Harden baseline XLSX loaders & inspector
        owner: codex
        status: done
        status_log:
          - status: in_progress
            at: "2025-10-08 17:46"
            actor: codex
          - status: done
            at: "2025-10-08 17:46"
            actor: codex
        deps: [P1.3]
        dod: "Delivery header synonyms expanded; strict size tokens; inspect CLI added"
      - id: P1.3c
        title: Align delivery workbook and offers sheet detection
        owner: codex
        status: done
        status_log:
          - status: in_progress
            at: "2025-10-08 19:17"
            actor: codex
          - status: done
            at: "2025-10-08 19:17"
            actor: codex
        deps: [P1.3b]
        dod: "Percent-based delivery bands and autodetected offers sheets handled"
      - id: P1.3d
        title: Harden delivery pct + offers store mapping
        owner: codex
        status: done
        status_log:
          - status: in_progress
            at: "2025-10-08 19:39"
            actor: codex
          - status: done
            at: "2025-10-08 19:39"
            actor: codex
        deps: [P1.3c]
        dod: "Loaders pass with percent delivery workbook and store-name accounts"
      - id: P1.3e
        title: Delivery bands auto-upgrade & ingest guards
        owner: codex
        status: done
        status_log:
          - status: in_progress
            at: "2025-10-08 20:40"
            actor: codex
          - status: done
            at: "2025-10-08 20:40"
            actor: codex
        deps: [P1.3d]
        dod: "SQLite reset flag + header tests keep baseline/offer ingest aligned"
      - id: P1.3f
        title: Finalize baseline ingest (percent bands + offers map)
        owner: codex
        status: done
        status_log:
          - status: in_progress
            at: "2025-10-08 21:34"
            actor: codex
          - status: done
            at: "2025-10-08 21:34"
            actor: codex
        deps: [P1.3e]
        dod: "Inspectors + loaders handle percent workbooks and Store_name mappings"
      - id: P1.3g
        title: Fix delivery band ingestion to accept zeros & default PlatformFeePct=0.12
        owner: codex
        status: done
        status_log:
          - status: done
            at: "2025-10-09 20:55"
            actor: codex
        deps: [P1.3f]
        dod: "Delivery loader accepts zero-value fees, defaults PlatformFeePct to 0.12 when blank, and logs canonical field names."
      - id: P1.3h
        title: Unify alias map across inspector and loader
        owner: codex
        status: done
        status_log:
          - status: done
            at: "2025-10-09 20:55"
            actor: codex
        deps: [P1.3g]
        dod: "Inspector and loader share DELIVERY_HEADER_MAP plus coercion helpers; headers resolve deterministically."
      - id: P1.3i
        title: Add delivery debug CLI
        owner: codex
        status: done
        status_log:
          - status: done
            at: "2025-10-09 20:55"
            actor: codex
        deps: [P1.3h]
        dod: "scripts/print_delivery_debug.py prints canonical delivery columns using shared alias/coercion logic."

  - id: P2
    name: Inventory Sync (Flow B + /inventory/update)
    tasks:
      - id: P2.1
        title: Implement /inventory/update endpoint
        owner: codex
        status: todo
        deps: [P1.1]
        dod: "POST accepts list of {offer_id, account_id, qty}; writes stock_snapshots; returns enable/disable list"
      - id: P2.2
        title: Aggregator logic per sku_key
        owner: codex
        status: todo
        deps: [P2.1]
        dod: "SQL/logic sums latest snapshot; accurate on test data; unit tests included"
      - id: P2.3
        title: n8n Flow B blueprint
        owner: codex
        status: todo
        deps: [P2.1]
        dod: "N8N_FLOWS.md section added; flow JSON exported or steps documented"
      - id: P2.4
        title: Offer allocation strategy (simple split)
        owner: codex
        status: todo
        deps: [P2.2]
        dod: "desired_allocations table or rule; documented in RULES.md"

  - id: P3
    name: Sales & Demand
    tasks:
      - id: P3.1
        title: Orders ingest (API or CSV fallback) → orders table
        owner: codex
        status: todo
        deps: [P1.1]
        dod: "Importer handles API and XLSX; idempotent upsert"
      - id: P3.2
        title: sales_daily aggregator
        owner: codex
        status: todo
        deps: [P3.1]
        dod: "Daily rollup job writes sales_daily; tested on sample"
      - id: P3.3
        title: Denoising & diagnostics (sigma, good_days, data_rating)
        owner: codex
        status: todo
        deps: [P3.2]
        dod: "diagnostics table populated; spike-day list honored; unit tests"
      - id: P3.4
        title: demand_forecasts: D_current (working), scenarios
        owner: codex
        status: todo
        deps: [P3.3]
        dod: "D_current set; optional scenarios stored; report endpoint shows summary"

  - id: P4
    name: Policy Compute (SS/ROP/T_post)
    tasks:
      - id: P4.1
        title: Implement SS/ROP compute job
        owner: codex
        status: todo
        deps: [P3.4]
        dod: "SS components + ROP stored per sku_key; JSON trace for decision_reason"
      - id: P4.2
        title: Governance checks & flags
        owner: codex
        status: todo
        deps: [P4.1]
        dod: "Invalid size sets, share sum, data_rating gates; warnings logged"

  - id: P5
    name: PO Planner (Per-size Allocation)
    tasks:
      - id: P5.1
        title: plan_reorder() core (T_post target)
        owner: codex
        status: todo
        deps: [P4.2]
        dod: "Returns alloc per size; writes po_plan; unit tests for allocator math"
      - id: P5.2
        title: Export PO report (CSV/PDF/MD)
        owner: codex
        status: todo
        deps: [P5.1]
        dod: "Report in outbox/ with run timestamp; fields include D, SS_total, T_post, Alloc_i"

  - id: P6
    name: Orders + WhatsApp (Flow A) & Size Engine
    tasks:
      - id: P6.1
        title: size_engine (deterministic rules)
        owner: codex
        status: todo
        deps: [P3.4]
        dod: "Function returns final_size + boundary_flag + reason"
      - id: P6.2
        title: /wa/parse webhook (text → height/weight/pref)
        owner: codex
        status: todo
        deps: [P6.1]
        dod: "Robust parser for RU variants; unit tests"
      - id: P6.3
        title: /decide endpoint (joins order+WA+offer)
        owner: codex
        status: todo
        deps: [P6.2]
        dod: "Implements 15:00 fallback; updates order + adjusts stock"
      - id: P6.4
        title: n8n Flow A blueprint
        owner: codex
        status: todo
        deps: [P6.3]
        dod: "N8N_FLOWS.md section added; flow steps documented"

  - id: P7
    name: Labels & Fulfillment
    tasks:
      - id: P7.1
        title: /labels/build (upload ZIP or list → grouped PDF)
        owner: codex
        status: todo
        deps: [P6.3]
        dod: "Groups by model/color; saved in outbox/; tested with sample"
      - id: P7.2
        title: WhatsApp media to self (optional)
        owner: codex
        status: todo
        deps: [P7.1]
        dod: "If provider allows media URL; otherwise UI download"

  - id: P8
    name: Analytics & Finance
    tasks:
      - id: P8.1
        title: Unit econ + ROIC compute
        owner: codex
        status: todo
        deps: [P3.4]
        dod: "COGS, Delivery (bands), NetRev, UnitProfit; ROIC monthly; report endpoint"

  - id: P9
    name: Docs, Cleanup, Hardening
    tasks:
      - id: P9.1
        title: Deprecate legacy scripts & docs
        owner: codex
        status: todo
        deps: [P2.2, P3.1]
        dod: "Archive/rename conflicts; update DATA_FILES_GUIDE"
      - id: P9.2
        title: Tests & backup scripts
        owner: codex
        status: todo
        deps: [P5.2]
        dod: "Key unit tests green; weekly DB dump job"
